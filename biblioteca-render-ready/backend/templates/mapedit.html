<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Editor de mapa — Bibliomap</title>
  <style>
    :root{--b:#e5e7eb;--t:#0f172a}
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:16px;color:var(--t)}
    main{display:grid;grid-template-columns:1fr 340px;gap:16px;align-items:start}
    #wrap{position:relative;border:1px solid var(--b);border-radius:10px;overflow:hidden;max-width:min(92vw,1200px)}
    #img{display:block;max-width:100%;height:auto;background:#fff}
    .box{position:absolute;border:2px solid #f33;background:rgba(255,0,0,.08);border-radius:8px}
    fieldset{border:1px solid var(--b);border-radius:10px;padding:12px}
    legend{padding:0 6px;font-weight:600}
    label{display:block;margin:6px 0 2px}
    input,select,button{width:100%;padding:8px;border:1px solid var(--b);border-radius:8px;box-sizing:border-box}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    #list{height:240px;overflow:auto;font-size:.92rem;border:1px solid var(--b);border-radius:8px;padding:8px}
    .small{font-size:.85rem;color:#64748b}
    .toolbar{display:flex;gap:8px;margin:8px 0}
    .btn{background:#fff;border:1px solid var(--b);border-radius:8px;padding:8px 10px;cursor:pointer}
    .btn.primary{background:#0f172a;color:#fff;border-color:#0f172a}
    .hidden{display:none}
    @media (max-width: 900px){ main{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header style="margin-bottom:12px;display:flex;gap:12px;align-items:center;justify-content:space-between">
    <h1 style="font-size:1.25rem;font-weight:700">Editor de mapa — Bibliomap</h1>
    <a href="/" class="btn">← Volver</a>
  </header>

  <main>
    <section>
      <!-- Coloca tu plano real en /static/mapa.png -->
      <div id="wrap">
        <img id="img" src="{{ url_for('static', filename='mapa.png') }}" alt="Plano de la biblioteca">
      </div>
      <div class="toolbar">
        <button id="undo" class="btn">Deshacer</button>
        <button id="clear" class="btn">Limpiar</button>
        <button id="dl" class="btn primary">Descargar mapping.csv</button>
      </div>
      <p class="small">Dibuja un rectángulo sobre el plano, completa los datos y pulsa <em>Guardar zona</em>. Repite para todos los estantes/anaqueles.</p>
    </section>

    <aside>
      <fieldset>
        <legend>Datos de la zona seleccionada</legend>
        <div class="row">
          <div>
            <label>Pasillo</label><input id="pasillo" placeholder="p.ej. 2">
          </div>
          <div>
            <label>Lado</label>
            <select id="lado"><option>A</option><option>B</option></select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Estantería</label><input id="est" type="number" min="0" placeholder="número">
          </div>
          <div>
            <label>Anaquel</label><input id="ana" type="number" min="0" placeholder="nivel">
          </div>
        </div>
        <button id="save" class="btn primary" style="margin-top:8px">Guardar zona</button>
      </fieldset>

      <fieldset style="margin-top:12px">
        <legend>Zonas guardadas</legend>
        <div id="list"></div>
      </fieldset>
    </aside>
  </main>

<script>
const wrap = document.getElementById('wrap');
const img  = document.getElementById('img');
const list = document.getElementById('list');
const state = { drawing:false, start:null, currentBox:null, areas:[], boxes:[] };

function clamp(v){ return Math.min(1, Math.max(0, v)); }
function relBox(b){
  const r = img.getBoundingClientRect();
  const x0 = parseFloat(b.style.left) / r.width;
  const y0 = parseFloat(b.style.top)  / r.height;
  const x1 = (parseFloat(b.style.left) + parseFloat(b.style.width))  / r.width;
  const y1 = (parseFloat(b.style.top)  + parseFloat(b.style.height)) / r.height;
  return {x0:clamp(x0), y0:clamp(y0), x1:clamp(x1), y1:clamp(y1)};
}
function pxBox(rel){
  const r = img.getBoundingClientRect();
  return {
    left:(rel.x0*r.width)+'px', top:(rel.y0*r.height)+'px',
    width:((rel.x1-rel.x0)*r.width)+'px', height:((rel.y1-rel.y0)*r.height)+'px'
  };
}
function addBox(style){ const d=document.createElement('div'); d.className='box'; Object.assign(d.style, style); wrap.appendChild(d); state.boxes.push(d); return d; }

function renderList(){
  list.innerHTML = '';
  state.areas.forEach((a, i)=>{
    const item = document.createElement('div');
    item.innerHTML = `#${i+1} — Pasillo ${a.pasillo} / Lado ${a.lado} / Est. ${a.estanteria} / Anaq. ${a.anaquel}
      <div class="small">x0=${a.x0.toFixed(3)}, y0=${a.y0.toFixed(3)}, x1=${a.x1.toFixed(3)}, y1=${a.y1.toFixed(3)}</div>`;
    item.style.cursor='pointer';
    item.onclick = ()=>{
      document.querySelectorAll('.box').forEach(b=>b.style.outline='none');
      state.boxes[i].style.outline='3px dashed #06f';
      document.getElementById('pasillo').value = a.pasillo;
      document.getElementById('lado').value    = a.lado;
      document.getElementById('est').value     = a.estanteria;
      document.getElementById('ana').value     = a.anaquel;
      state.currentBox = state.boxes[i];
    };
    list.appendChild(item);
  });
}
function redraw(){ state.areas.forEach((a,i)=> Object.assign(state.boxes[i].style, pxBox(a)) ); }
img.addEventListener('load', redraw);

wrap.addEventListener('mousedown', (e)=>{
  if(e.target!==img) return;
  const r = img.getBoundingClientRect();
  state.drawing = true;
  state.start = { x: e.clientX - r.left, y: e.clientY - r.top };
  state.currentBox = addBox({left:state.start.x+'px', top:state.start.y+'px', width:'0px', height:'0px'});
});
window.addEventListener('mousemove', (e)=>{
  if(!state.drawing) return;
  const r = img.getBoundingClientRect();
  const x = e.clientX - r.left, y = e.clientY - r.top;
  const left = Math.min(state.start.x, x);
  const top  = Math.min(state.start.y, y);
  const w = Math.abs(x - state.start.x);
  const h = Math.abs(y - state.start.y);
  Object.assign(state.currentBox.style, {left:left+'px', top:top+'px', width:w+'px', height:h+'px'});
});
window.addEventListener('mouseup', ()=>{ state.drawing=false; });

document.getElementById('save').onclick = ()=>{
  if(!state.currentBox){ alert('Dibuja una caja sobre el plano primero.'); return; }
  const a = {
    pasillo: document.getElementById('pasillo').value.trim(),
    lado: document.getElementById('lado').value,
    estanteria: parseInt(document.getElementById('est').value,10),
    anaquel: parseInt(document.getElementById('ana').value,10),
    ...relBox(state.currentBox)
  };
  if(!a.pasillo || isNaN(a.estanteria) || isNaN(a.anaquel)){
    alert('Completa pasillo, estantería y anaquel.'); return;
  }
  state.areas.push(a);
  state.currentBox = null;
  renderList();
};

document.getElementById('undo').onclick = ()=>{
  if(state.areas.length===0) return;
  state.areas.pop();
  const b = state.boxes.pop();
  if (b) b.remove();
  renderList();
};

document.getElementById('clear').onclick = ()=>{
  state.areas = [];
  state.boxes.forEach(b=>b.remove());
  state.boxes = [];
  renderList();
};

document.getElementById('dl').onclick = ()=>{
  if(state.areas.length===0){ alert('No hay zonas.'); return; }
  const head = 'pasillo,lado,estanteria,anaquel,x0,y0,x1,y1';
  const rows = state.areas.map(a=>[a.pasillo,a.lado,a.estanteria,a.anaquel,a.x0,a.y0,a.x1,a.y1].join(','));
  const csv = [head, ...rows].join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='mapping.csv'; a.click();
  URL.revokeObjectURL(url);
};

window.addEventListener('resize', redraw);
</script>
</body>
</html>
